<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>AngelScript: Registering a reference type</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="contents">
<h1><a class="anchor" name="doc_register_ref_type">Registering a reference type </a></h1><ul>
<li><a class="el" href="doc_register_ref_type.html#doc_reg_basicref">Registering a basic reference type</a></li><li><a class="el" href="doc_register_ref_type.html#doc_reg_noinst">Registering an uninstanciable reference type</a></li><li><a class="el" href="doc_register_ref_type.html#doc_reg_single">Registering a single-reference type</a></li><li><a class="el" href="doc_register_ref_type.html#doc_reg_scoped">Registering a scoped type</a></li></ul>
<p>
<dl class="see" compact><dt><b>See also:</b></dt><dd><a class="el" href="doc_gc_object.html">Implementing a garbage collected object</a>, <a class="el" href="doc_adv_class_hierarchy.html">Registering class hierarchies</a></dd></dl>
<h2><a class="anchor" name="doc_reg_basicref">
Registering a basic reference type</a></h2>
The basic reference type should be registered with the following behaviours: asBEHAVE_FACTORY, asBEHAVE_ADDREF, and asBEHAVE_RELEASE. If it is desired that assignments should be allowed for the type the asBEHAVE_ASSIGNMENT behaviour must be registered as well. Other behaviours, such as math operators, comparisons, etc may be registered as needed.<p>
<div class="fragment"><pre class="fragment"><span class="comment">// Registering the reference type</span>
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#29c6c087c8c5b5cdb6271cfd161cc5a6" title="Registers a new object type.">RegisterObjectType</a>(<span class="stringliteral">"ref"</span>, 0, <a class="code" href="angelscript_8h.html#855d86fa9ee15b9f75e553ee376b5c7a9450e038342b36c745858d2e5ae4b861" title="A reference type.">asOBJ_REF</a>); assert( r &gt;= 0 );
</pre></div><p>
<dl class="see" compact><dt><b>See also:</b></dt><dd>The <a class="el" href="doc_addon_string.html">string</a> add-on for an example of a reference type</dd></dl>
<h3><a class="anchor" name="doc_reg_basicref_1">
Factory function</a></h3>
The factory function is the one that AngelScript will use to instanciate objects of this type when a variable is declared. It is responsible for allocating and initializing the object memory.<p>
The default factory function doesn't take any parameters and should return an object handle for the new object. Make sure the object's reference counter is accounting for the reference being returned by the factory function, so that the object is properly released when all references to it are removed.<p>
<div class="fragment"><pre class="fragment">CRef::CRef()
{
    <span class="comment">// Let the constructor initialize the reference counter to 1</span>
    refCount = 1;
}

CRef *Ref_Factory()
{
    <span class="comment">// The class constructor is initializing the reference counter to 1</span>
    <span class="keywordflow">return</span> <span class="keyword">new</span> CRef();
}

<span class="comment">// Registering the factory behaviour</span>
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#7ea3c93dea338b0287027de0e4895dcb" title="Registers a behaviour for the object type.">RegisterObjectBehaviour</a>(<span class="stringliteral">"ref"</span>, <a class="code" href="angelscript_8h.html#7e38df5b10ec8cbf2a688f1d114097c50b3db16eea35213b6f41f8d19dc1bd4c" title="(Object) Factory">asBEHAVE_FACTORY</a>, <span class="stringliteral">"ref@ f()"</span>, <a class="code" href="angelscript_8h.html#78f8f2c7f1c88b12e74a5ac47b4184ae" title="Returns an asSFuncPtr representing the function specified by the name.">asFUNCTION</a>(Ref_Factory), <a class="code" href="angelscript_8h.html#3ec92ea3c4762e44c2df788ceccdd1e468ae43cc91cdfc3fa4590c9e6164e4f4" title="A cdecl function.">asCALL_CDECL</a>); assert( r &gt;= 0 );
</pre></div><p>
You may also register factory functions that take parameters, which may then be used when initializing the object.<p>
The factory function must be registered as a global function, but can be implemented as a static class method, common global function, or a global function following the generic calling convention.<h3><a class="anchor" name="doc_reg_basicref_2">
Addref and release behaviours</a></h3>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> CRef::Addref()
{
    <span class="comment">// Increase the reference counter</span>
    refCount++;
}

<span class="keywordtype">void</span> CRef::Release()
{
    <span class="comment">// Decrease ref count and delete if it reaches 0</span>
    <span class="keywordflow">if</span>( --refCount == 0 )
        <span class="keyword">delete</span> <span class="keyword">this</span>;
}

<span class="comment">// Registering the addref/release behaviours</span>
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#7ea3c93dea338b0287027de0e4895dcb" title="Registers a behaviour for the object type.">RegisterObjectBehaviour</a>(<span class="stringliteral">"ref"</span>, <a class="code" href="angelscript_8h.html#7e38df5b10ec8cbf2a688f1d114097c51dfa5b72ad69a7bf70636d4fcb1b1d84" title="(Object) AddRef">asBEHAVE_ADDREF</a>, <span class="stringliteral">"void f()"</span>, <a class="code" href="angelscript_8h.html#7345e6b3afabec24efd0ff77886d49a6" title="Returns an asSFuncPtr representing the class method specified by class and method...">asMETHOD</a>(CRef,AddRef), <a class="code" href="angelscript_8h.html#3ec92ea3c4762e44c2df788ceccdd1e4ea516c8742acc1edff6a43dc1bb09e96" title="A thiscall class method.">asCALL_THISCALL</a>); assert( r &gt;= 0 );
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#7ea3c93dea338b0287027de0e4895dcb" title="Registers a behaviour for the object type.">RegisterObjectBehaviour</a>(<span class="stringliteral">"ref"</span>, <a class="code" href="angelscript_8h.html#7e38df5b10ec8cbf2a688f1d114097c57134ce13c81967191af401a1e5170a0c" title="(Object) Release">asBEHAVE_RELEASE</a>, <span class="stringliteral">"void f()"</span>, <a class="code" href="angelscript_8h.html#7345e6b3afabec24efd0ff77886d49a6" title="Returns an asSFuncPtr representing the class method specified by class and method...">asMETHOD</a>(CRef,Release), <a class="code" href="angelscript_8h.html#3ec92ea3c4762e44c2df788ceccdd1e4ea516c8742acc1edff6a43dc1bb09e96" title="A thiscall class method.">asCALL_THISCALL</a>); assert( r &gt;= 0 );
</pre></div><h3><a class="anchor" name="doc_reg_basicref_3">
Assignment behaviour</a></h3>
<div class="fragment"><pre class="fragment">CRef &amp;CRef::operator =(<span class="keyword">const</span> CRef &amp;other)
{
    <span class="comment">// Copy everything from the other class, except the reference counter</span>
}

<span class="comment">// Registering the assignment behaviour</span>
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#7ea3c93dea338b0287027de0e4895dcb" title="Registers a behaviour for the object type.">RegisterObjectBehaviour</a>(<span class="stringliteral">"ref"</span>, <a class="code" href="angelscript_8h.html#7e38df5b10ec8cbf2a688f1d114097c5bc550883ee918a9df8aef130aa9c567c" title="(Object) operator =">asBEHAVE_ASSIGNMENT</a>, <span class="stringliteral">"ref &amp;f(const &amp;in)"</span>, <a class="code" href="angelscript_8h.html#7345e6b3afabec24efd0ff77886d49a6" title="Returns an asSFuncPtr representing the class method specified by class and method...">asMETHOD</a>(CRef,<span class="keyword">operator</span>=), <a class="code" href="angelscript_8h.html#3ec92ea3c4762e44c2df788ceccdd1e4ea516c8742acc1edff6a43dc1bb09e96" title="A thiscall class method.">asCALL_THISCALL</a>); assert( r &gt;= 0 );
</pre></div><p>
The assignment behaviour can be overloaded with other types if that is desired, that way the script writer doesn't have to manually convert the expressions before assigning the values to the type.<h2><a class="anchor" name="doc_reg_noinst">
Registering an uninstanciable reference type</a></h2>
Sometimes it may be useful to register types that cannot be instanciated by the scripts, yet can be interacted with. You can do this by registering the type as a normal reference type, but omit the registration of the factory behaviour. You can later register global properties, or functions that allow the scripts to access objects created by the application via object handles.<p>
This would be used when the application has a limited number of objects available and doesn't want to create new ones. For example singletons, or pooled objects.<h2><a class="anchor" name="doc_reg_single">
Registering a single-reference type</a></h2>
A variant of the uninstanciable reference types is the single-reference type. This is a type that have only 1 reference accessing it, i.e. the script cannot store any extra references to the object during execution. The script is forced to use the reference it receives from the application at the moment the application passes it on to the script.<p>
The reference can be passed to the script through a property, either global or a class member, or it can be returned from an application registered function or class method.<p>
<div class="fragment"><pre class="fragment"><span class="comment">// Registering the type so that it cannot be instanciated</span>
<span class="comment">// by the script, nor allow scripts to store references to the type</span>
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#29c6c087c8c5b5cdb6271cfd161cc5a6" title="Registers a new object type.">RegisterObjectType</a>(<span class="stringliteral">"single"</span>, 0, <a class="code" href="angelscript_8h.html#855d86fa9ee15b9f75e553ee376b5c7a9450e038342b36c745858d2e5ae4b861" title="A reference type.">asOBJ_REF</a> | <a class="code" href="angelscript_8h.html#855d86fa9ee15b9f75e553ee376b5c7afa1830b02c4d51ddc25451e7ad1a7592" title="This reference type doesn&amp;#39;t allow handles to be held. Only valid for reference...">asOBJ_NOHANDLE</a>); assert( r &gt;= 0 );
</pre></div><p>
This sort of type is most useful when you want to have complete control over references to an object, for example so that the application can destroy and recreate objects of the type without having to worry about potential references held by scripts. This allows the application to control when a script has access to an object and it's members.<h2><a class="anchor" name="doc_reg_scoped">
Registering a scoped type</a></h2>
Some C++ value types have special requirements for the memory where they are located, e.g. specific alignment needs, or memory pooling. Since AngelScript doesn't provide that much control over where and how value types are allocated, they must be registered as reference types. In this case you'd register the type as a scoped reference type.<p>
A scoped reference type will have the life time controlled by the scope of the variable that instanciate it, i.e. as soon as the variable goes out of scope the instance is destroyed. This means that the type doesn't permit handles to be taken for the type.<p>
A scoped reference type requires two behaviours to be registered, the factory and the release behaviour. The addref behaviour is not permitted.<p>
Since no handles can be taken for the object type, there is no need to keep track of the number of references held to the object. This means that the release behaviour should simply destroy and deallocate the object as soon as it's called.<p>
<div class="fragment"><pre class="fragment">scoped *Scoped_Factory()
{
  <span class="keywordflow">return</span> <span class="keyword">new</span> scoped;
}

<span class="keywordtype">void</span> Scoped_Release(scoped *s)
{
  <span class="keywordflow">if</span>( s ) <span class="keyword">delete</span> s;
}

<span class="comment">// Registering a scoped reference type</span>
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#29c6c087c8c5b5cdb6271cfd161cc5a6" title="Registers a new object type.">RegisterObjectType</a>(<span class="stringliteral">"scoped"</span>, 0, <a class="code" href="angelscript_8h.html#855d86fa9ee15b9f75e553ee376b5c7a9450e038342b36c745858d2e5ae4b861" title="A reference type.">asOBJ_REF</a> | <a class="code" href="angelscript_8h.html#855d86fa9ee15b9f75e553ee376b5c7aaae92b24e278976320f19d9dc75fe6db" title="The life time of objects of this type are controlled by the scope of the variable...">asOBJ_SCOPED</a>); assert( r &gt;= 0 );
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#7ea3c93dea338b0287027de0e4895dcb" title="Registers a behaviour for the object type.">RegisterObjectBehaviour</a>(<span class="stringliteral">"scoped"</span>, <a class="code" href="angelscript_8h.html#7e38df5b10ec8cbf2a688f1d114097c50b3db16eea35213b6f41f8d19dc1bd4c" title="(Object) Factory">asBEHAVE_FACTORY</a>, <span class="stringliteral">"scoped @f()"</span>, <a class="code" href="angelscript_8h.html#78f8f2c7f1c88b12e74a5ac47b4184ae" title="Returns an asSFuncPtr representing the function specified by the name.">asFUNCTION</a>(Scoped_Factory), <a class="code" href="angelscript_8h.html#3ec92ea3c4762e44c2df788ceccdd1e468ae43cc91cdfc3fa4590c9e6164e4f4" title="A cdecl function.">asCALL_CDECL</a>); assert( r &gt;= 0 );
r = engine-&gt;<a class="code" href="classas_i_script_engine.html#7ea3c93dea338b0287027de0e4895dcb" title="Registers a behaviour for the object type.">RegisterObjectBehaviour</a>(<span class="stringliteral">"scoped"</span>, <a class="code" href="angelscript_8h.html#7e38df5b10ec8cbf2a688f1d114097c57134ce13c81967191af401a1e5170a0c" title="(Object) Release">asBEHAVE_RELEASE</a>, <span class="stringliteral">"void f()"</span>, <a class="code" href="angelscript_8h.html#78f8f2c7f1c88b12e74a5ac47b4184ae" title="Returns an asSFuncPtr representing the function specified by the name.">asFUNCTION</a>(Scoped_Release), <a class="code" href="angelscript_8h.html#3ec92ea3c4762e44c2df788ceccdd1e4c08652c72f1cc0dc81c37812fab0e253" title="A cdecl function that takes the object pointer as the last parameter.">asCALL_CDECL_OBJLAST</a>); assert( r &gt;= 0 );
</pre></div> </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sat May 9 14:45:54 2009 for AngelScript by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9 </small></address>
</body>
</html>
